{% extends "layout.html" %}

{% block page_title %}Giri≈ü / M√º≈üteri Kaydƒ±{% endblock %}

{% block content %}
<style>
.giris-container {
    display: grid;
    grid-template-columns: 1fr 1.2fr;
    gap: 15px;
}
.giris-header {
    background: #0f2537;
    padding: 10px 12px;
    margin: -10px -10px 10px -10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.giris-header h2 {
    color: #4fc3f7;
    margin: 0;
    font-size: 16px;
}
.giris-buttons button {
    background: #00bcd4;
    color: white;
    border: none;
    padding: 7px 14px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
    margin-left: 6px;
}
.completion-bar {
    background: #1e3a50;
    padding: 10px 12px;
    margin-bottom: 10px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 12px;
}
.completion-bar label {
    color: #b0bec5;
    font-size: 13px;
    font-weight: bold;
}
.progress-bar {
    flex: 1;
    background: #2d4060;
    height: 20px;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
}
.progress-fill {
    background: linear-gradient(90deg, #00bcd4, #00e676);
    height: 100%;
    width: 0%;
    transition: width 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 11px;
    font-weight: bold;
}
.musteri-liste {
    background: #1e3a50;
    padding: 12px;
    border-radius: 4px;
}
.musteri-liste h3 {
    color: #4fc3f7;
    font-size: 14px;
    margin: 0 0 10px 0;
    padding-bottom: 6px;
    border-bottom: 1px solid #2d4060;
}
.arama-box {
    margin-bottom: 10px;
}
.arama-box input {
    width: 100%;
    background: #2d4060;
    border: 1px solid #3d5070;
    color: #e0f7fa;
    padding: 8px 12px;
    border-radius: 3px;
    font-size: 13px;
}
.arama-box button {
    width: 100%;
    background: #00695c;
    color: white;
    border: none;
    padding: 8px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
    margin-top: 6px;
}
.musteri-liste-items {
    max-height: 450px;
    overflow-y: auto;
    background: #0f2537;
    border-radius: 3px;
}
.musteri-item {
    padding: 10px;
    border-bottom: 1px solid #2d4060;
    cursor: pointer;
    transition: background 0.2s;
}
.musteri-item:hover {
    background: #2d4060;
}
.musteri-item.selected {
    background: #00695c;
}
.musteri-item .name {
    color: #4fc3f7;
    font-weight: bold;
    font-size: 13px;
}
.musteri-item .vergi {
    color: #90a4ae;
    font-size: 11px;
    margin-top: 2px;
}
.musteri-form {
    background: #1e3a50;
    padding: 12px;
    border-radius: 4px;
    max-height: 700px;
    overflow-y: auto;
}
.musteri-form h3 {
    color: #4fc3f7;
    font-size: 14px;
    margin: 0 0 10px 0;
    padding-bottom: 6px;
    border-bottom: 1px solid #2d4060;
}
.tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 12px;
    border-bottom: 2px solid #2d4060;
}
.tab {
    padding: 8px 16px;
    background: transparent;
    border: none;
    color: #90a4ae;
    cursor: pointer;
    font-size: 12px;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
}
.tab.active {
    color: #4fc3f7;
    border-bottom-color: #4fc3f7;
    background: rgba(79, 195, 247, 0.1);
}
.tab-content {
    display: none;
}
.tab-content.active {
    display: block;
}
.form-grid {
    display: grid;
    grid-template-columns: 140px 1fr;
    gap: 8px 12px;
    align-items: center;
}
.form-grid label {
    color: #b0bec5;
    font-size: 12px;
    text-align: right;
}
.form-grid label.required::after {
    content: " *";
    color: #ff5252;
}
.form-grid input, .form-grid select, .form-grid textarea {
    background: #2d4060;
    border: 1px solid #3d5070;
    color: #e0f7fa;
    padding: 6px 10px;
    border-radius: 3px;
    font-size: 12px;
}
.form-grid input:focus, .form-grid select:focus, .form-grid textarea:focus {
    border-color: #00bcd4;
    outline: none;
}
.form-grid textarea {
    resize: vertical;
    min-height: 60px;
}
.form-section {
    margin-bottom: 15px;
}
.form-section h4 {
    color: #4fc3f7;
    font-size: 13px;
    margin: 0 0 8px 0;
}
.evrak-belgeler {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}
.evrak-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: #b0bec5;
}
.evrak-item input[type="checkbox"] {
    width: 16px;
    height: 16px;
}
.dosyalar {
    padding: 12px;
    background: #0f2537;
    border-radius: 3px;
    min-height: 100px;
}
.dosya-yukle-box {
    border: 2px dashed #3d5070;
    padding: 20px;
    text-align: center;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s;
}
.dosya-yukle-box:hover {
    border-color: #00bcd4;
    background: rgba(0, 188, 212, 0.05);
}
.dosya-yukle-box i {
    font-size: 32px;
    color: #00bcd4;
    margin-bottom: 8px;
}
.dosya-yukle-box p {
    color: #90a4ae;
    font-size: 12px;
    margin: 4px 0;
}
.dosya-liste {
    margin-top: 12px;
}
.dosya-item {
    background: #2d4060;
    padding: 8px 12px;
    border-radius: 3px;
    margin-bottom: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.dosya-item span {
    color: #e0f7fa;
    font-size: 11px;
}
.dosya-item button {
    background: #e74c3c;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 10px;
}
.form-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #2d4060;
}
.form-actions button {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
    font-weight: bold;
}
.btn-kaydet { background: #00bcd4; color: white; }
.btn-sozlesme { background: #9c27b0; color: white; }
.btn-yazdir { background: #ff9800; color: white; }
.btn-sil { background: #e74c3c; color: white; }
.btn-temizle { background: #6b7280; color: white; }
.sozlesme-durum {
    margin-top: 10px;
    padding: 10px;
    background: #0f2537;
    border-radius: 3px;
}
.sozlesme-durum p {
    margin: 0;
    color: #6b7280;
    font-size: 12px;
}
.sozlesme-durum.var {
    background: #1a4d2e;
}
.sozlesme-durum.var p {
    color: #4caf50;
}
@media (max-width: 1024px) {
    .giris-container {
        grid-template-columns: 1fr;
    }
}
</style>

<div class="giris-header">
    <h2>üìã Giri≈ü / M√º≈üteri Kaydƒ±</h2>
    <div class="giris-buttons">
        <button onclick="yeniMusteri()" style="background: #4caf50;">‚ûï Yeni M√º≈üteri</button>
        <button onclick="location.reload()">‚Ü∫ Yenile</button>
    </div>
</div>

<!-- Tamamlanma √áubuƒüu -->
<div class="completion-bar">
    <label>Tamamlanma:</label>
    <div class="progress-bar">
        <div class="progress-fill" id="completion-fill">0%</div>
    </div>
</div>

<div class="giris-container">
    <!-- Sol: M√º≈üteri Listesi -->
    <div class="musteri-liste">
        <h3>M√º≈üteri Listesi</h3>
        
        <div class="arama-box">
            <input type="text" id="arama-input" placeholder="M√º≈üteri adƒ± veya vergi no ara..." onkeyup="musteriAra()">
            <button onclick="temizle()">‚úñ Temizle</button>
        </div>
        
        <div class="musteri-liste-items" id="musteri-liste">
            <div style="padding: 20px; text-align: center; color: #6b7280; font-size: 12px;">
                M√º≈üteri arayƒ±n veya yeni kayƒ±t olu≈üturun
            </div>
        </div>
    </div>
<!-- Saƒü: M√º≈üteri Formu -->
    <div class="musteri-form">
        <h3>M√º≈üteri Ekle / G√ºncelle</h3>
        
        <!-- Sekmeler -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">M√º≈üteri Ekle</button>
            <button class="tab" onclick="switchTab(1)">Kira Senaryo</button>
            <button class="tab" onclick="switchTab(2)">Kira Bildirgesi</button>
        </div>
        
        <!-- Sekme 1: M√º≈üteri Ekle -->
        <div class="tab-content active" id="tab-0">
            <form id="musteri-form" onsubmit="kaydet(event)">
                <input type="hidden" id="musteri-id">
                
                <!-- ≈ûirket Bilgileri -->
                <div class="form-section">
                    <h4>≈ûirket Bilgileri</h4>
                    <div class="form-grid">
                        <label class="required">≈ûirket √únvanƒ±</label>
                        <input type="text" id="name" required onchange="hesaplaYuzde()">
                        
                        <label class="required">Vergi Numarasƒ±</label>
                        <input type="text" id="tax_number" required onchange="hesaplaYuzde()">
                        
                        <label>Vergi Dairesi</label>
                        <input type="text" id="vergi_dairesi" onchange="hesaplaYuzde()">
                        
                        <label>MERSƒ∞S Numarasƒ±</label>
                        <input type="text" id="mersis" onchange="hesaplaYuzde()">
                        
                        <label>Ticaret Sicil No</label>
                        <input type="text" id="ticaret_sicil" onchange="hesaplaYuzde()">
                        
                        <label>Kurulu≈ü Tarihi</label>
                        <input type="date" id="kurulus_tarihi" onchange="hesaplaYuzde()">
                        
                        <label>Faaliyet Konusu</label>
                        <input type="text" id="faaliyet" onchange="hesaplaYuzde()">
                        
                        <label>NACE Kodu</label>
                        <input type="text" id="nace" onchange="hesaplaYuzde()">
                    </div>
                </div>
                
                <!-- Adres -->
                <div class="form-section">
                    <h4>Adres</h4>
                    <div class="form-grid">
                        <label>√ñnceki Adres</label>
                        <input type="text" id="onceki_adres" onchange="hesaplaYuzde()">
                        
                        <label class="required">≈ûu Anki Adres</label>
                        <textarea id="address" required onchange="hesaplaYuzde()"></textarea>
                        
                        <label>≈ûube / Merkez</label>
                        <select id="sube_merkez" onchange="hesaplaYuzde()">
                            <option>Merkez</option>
                            <option>≈ûube</option>
                        </select>
                    </div>
                </div>
                
                <!-- Yetkili -->
                <div class="form-section">
                    <h4>Yetkili Bilgileri</h4>
                    <div class="form-grid">
                        <label class="required">Yetkili Ad Soyad</label>
                        <input type="text" id="yetkili_ad" required onchange="hesaplaYuzde()">
                        
                        <label>Yetkili T.C. Kimlik No</label>
                        <input type="text" id="yetkili_tc" placeholder="11=TC / 12=Yab" onchange="hesaplaYuzde()">
                        
                        <label>Yetkili Cep Telefon</label>
                        <input type="text" id="phone" placeholder="5XX XXX XX XX" onchange="hesaplaYuzde()">
                        
                        <label>Yetkili Cep Tel 2</label>
                        <input type="text" id="phone2" onchange="hesaplaYuzde()">
                        
                        <label>Yetkili E-posta</label>
                        <input type="email" id="email" onchange="hesaplaYuzde()">
                        
                        <label>E-posta (≈üirket)</label>
                        <input type="email" id="email_sirket" onchange="hesaplaYuzde()">
                    </div>
                </div>
                
                <!-- S√∂zle≈üme -->
                <div class="form-section">
                    <h4>S√∂zle≈üme</h4>
                    <div class="form-grid">
                        <label>Hizmet T√ºr√º</label>
                        <select id="hizmet_turu" onchange="hesaplaYuzde()">
                            <option>Sanal Ofis</option>
                            <option>Hazƒ±r Ofis</option>
                            <option>Payla≈üƒ±mlƒ± Ofis</option>
                        </select>
                        
                        <label>Aylƒ±k Kira (‚Ç∫)</label>
                        <input type="number" step="0.01" id="aylik_kira" value="0.00" onchange="hesaplaYuzde()">
                        
                        <label>S√∂zle≈üme Ba≈ülangƒ±√ß</label>
                        <input type="date" id="sozlesme_baslangic" onchange="hesaplaYuzde()">
                        
                        <label>S√∂zle≈üme Biti≈ü</label>
                        <input type="date" id="sozlesme_bitis" onchange="hesaplaYuzde()">
                    </div>
                </div>
                
                <!-- Evrak ve Belgeler -->
                <div class="form-section">
                    <h4>Evrak ve Belgeler</h4>
                    <div class="evrak-belgeler">
                        <div class="evrak-item">
                            <input type="checkbox" id="ev_imza_sirk√ºleri" onchange="hesaplaYuzde()">
                            <label for="ev_imza_sirk√ºleri">ƒ∞mza Sirk√ºleri</label>
                        </div>
                        <div class="evrak-item">
                            <input type="checkbox" id="ev_vergi_levhasi" onchange="hesaplaYuzde()">
                            <label for="ev_vergi_levhasi">Vergi Levhasƒ±</label>
                        </div>
                        <div class="evrak-item">
                            <input type="checkbox" id="ev_ticaret_sicil" onchange="hesaplaYuzde()">
                            <label for="ev_ticaret_sicil">Ticaret Sicil</label>
                        </div>
                        <div class="evrak-item">
                            <input type="checkbox" id="ev_faaliyet_belgesi" onchange="hesaplaYuzde()">
                            <label for="ev_faaliyet_belgesi">Faaliyet Belgesi</label>
                        </div>
                        <div class="evrak-item">
                            <input type="checkbox" id="ev_ikametgah" onchange="hesaplaYuzde()">
                            <label for="ev_ikametgah">ƒ∞kametg√¢h</label>
                        </div>
                        <div class="evrak-item">
                            <input type="checkbox" id="ev_kase_ornegi" onchange="hesaplaYuzde()">
                            <label for="ev_kase_ornegi">Ka≈üe √ñrneƒüi</label>
                        </div>
                    </div>
                </div>
                
                <!-- Y√ºklenen Dosyalar -->
                <div class="form-section">
                    <h4>Y√ºklenen Dosyalar</h4>
                    <div class="dosyalar">
                        <div class="dosya-yukle-box" onclick="document.getElementById('file-input').click()">
                            <i class="fa fa-cloud-upload-alt"></i>
                            <p><strong>Dosya Y√ºkle</strong></p>
                            <p>PNG, JPG, PDF, DOCX (Max 10MB)</p>
                        </div>
                        <input type="file" id="file-input" style="display:none" accept=".png,.jpg,.jpeg,.pdf,.docx" onchange="dosyaYukle()">
                        <div class="dosya-liste" id="dosya-liste"></div>
                    </div>
                </div>
                
                <!-- Notlar -->
                <div class="form-grid">
                    <label>Notlar</label>
                    <textarea id="notes" rows="3" onchange="hesaplaYuzde()"></textarea>
                </div>
                
                <!-- S√∂zle≈üme Durumu -->
                <div class="sozlesme-durum" id="sozlesme-durum">
                    <p>Hen√ºz s√∂zle≈üme olu≈üturulmadƒ±.</p>
                </div>
                
                <!-- Butonlar -->
                <div class="form-actions">
                    <button type="submit" class="btn-kaydet">üíæ Kaydet</button>
                    <button type="button" class="btn-sozlesme" onclick="sozlesmeOlustur()">üìÑ S√∂zle≈üme Olu≈ütur</button>
                    <button type="button" class="btn-yazdir" onclick="yazdir()">üñ® Yazdƒ±r</button>
                    <button type="button" class="btn-sil" onclick="sil()">üóë Sil</button>
                    <button type="button" class="btn-temizle" onclick="temizleForm()">‚úñ Temizle</button>
                </div>
            </form>
        </div>
        
        <!-- Sekme 2: Kira Senaryo -->
<div class="tab-content" id="tab-1">
    <div style="background: #1e3a50; padding: 15px; border-radius: 4px;">
        <h4 style="color: #4fc3f7; margin: 0 0 15px 0;">Kira Senaryo Hesaplama</h4>
        
        <div class="form-grid">
            <label>M√º≈üteri ƒ∞smi</label>
            <input type="text" id="senaryo_musteri_ismi" placeholder="M√º≈üteri adƒ± girebilirsiniz (opsiyonel)">

            <label class="required">Ba≈ülangƒ±√ß Kira (‚Ç∫)</label>
            <input type="number" step="0.01" id="senaryo_baslangic_kira" placeholder="√ñrn: 5000">
            
            <label class="required">Ba≈ülangƒ±√ß Tarihi</label>
            <input type="date" id="senaryo_baslangic_tarih">
            
            <label class="required">Ka√ß Yƒ±l?</label>
            <input type="number" id="senaryo_yil_sayisi" value="5" min="1" max="10">
            

        </div>
        
        <div style="margin-top: 15px; text-align: center;">
            <button onclick="kiraSenaryo()" style="background: #00bcd4; color: white; border: none; padding: 10px 30px; border-radius: 3px; cursor: pointer; font-size: 13px; font-weight: bold;">
                üìä Hesapla
            </button>
            <button onclick="senaryoTemizle()" style="background: #6b7280; color: white; border: none; padding: 10px 30px; border-radius: 3px; cursor: pointer; font-size: 13px; font-weight: bold; margin-left: 8px;">
                ‚úñ Temizle
            </button>
            <button onclick="tufeVerileri()" style="background: #9c27b0; color: white; border: none; padding: 10px 30px; border-radius: 3px; cursor: pointer; font-size: 13px; font-weight: bold; margin-left: 8px;">
                üìä TCMB T√úFE Verileri
            </button>
            <button onclick="excelIndir()" style="background: #4caf50; color: white; border: none; padding: 10px 30px; border-radius: 3px; cursor: pointer; font-size: 13px; font-weight: bold; margin-left: 8px;">
                üì• Excel ƒ∞ndir
            </button>
        </div>
        
        <!-- Sonu√ß Tablosu -->
        <div id="senaryo-sonuc" style="margin-top: 20px; display: none;">
            <h4 style="color: #4fc3f7; margin: 15px 0 10px 0;">Kira Projeksiyonu</h4>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; background: #0f2537; border-radius: 3px;">
                    <thead>
                        <tr style="background: #0097a7; color: white;">
                            <th style="padding: 8px; text-align: left; font-size: 11px;">Yƒ±l</th>
                            <th style="padding: 8px; text-align: right; font-size: 11px;">Aylƒ±k Kira</th>
                            <th style="padding: 8px; text-align: right; font-size: 11px;">Yƒ±llƒ±k Toplam</th>
                            <th style="padding: 8px; text-align: right; font-size: 11px;">Artƒ±≈ü %</th>
                            <th style="padding: 8px; text-align: right; font-size: 11px;">Artƒ±≈ü Tutar</th>
                        </tr>
                    </thead>
                    <tbody id="senaryo-tablo">
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 15px; padding: 12px; background: #0f2537; border-radius: 3px; border-left: 3px solid #4caf50;">
                <p style="margin: 0; color: #4caf50; font-weight: bold; font-size: 13px;">
                    Toplam Kira Geliri (<span id="senaryo-toplam-yil"></span> Yƒ±l): 
                    <span id="senaryo-toplam-tutar"></span> TL
                </p>
            </div>
        </div>
    </div>
</div>

        <!-- Sekme 3: Kira Bildirgesi -->
        <div class="tab-content" id="tab-2">
            <div style="background: #1e3a50; padding: 15px; border-radius: 4px;">
                <h4 style="color: #4fc3f7; margin: 0 0 15px 0;">Kira Bildirgesi Olu≈ütur</h4>
                <p style="color: #90a4ae; font-size: 12px; margin-bottom: 15px;">M√º≈üteriyi a≈üaƒüƒ±daki listeden se√ßin veya manuel yazƒ±n. Yeni kira tutarƒ± ile bildirge PDF'i olu≈üturup √∂nizleyebilir, yazdƒ±rabilir veya WhatsApp ile g√∂nderebilirsiniz.</p>
                <div class="form-grid">
                    <label>M√º≈üteri</label>
                    <div style="grid-column: 2;">
                        <input type="text" id="bildirge_musteri_adi" placeholder="M√º≈üteri adƒ±nƒ± yazƒ±n veya a≈üaƒüƒ±dan se√ßin" style="width: 100%; margin-bottom: 6px;">
                        <button type="button" onclick="bildirgeMusteriListeToggle()" style="background: #0f2537; color: #4fc3f7; border: 1px solid #2d4060; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 12px;">üìã Listeden Se√ß</button>
                        <div id="bildirge_musteri_liste" style="display: none; max-height: 200px; overflow-y: auto; background: #0f2537; border: 1px solid #2d4060; border-radius: 4px; margin-top: 6px;">
                            <div style="padding: 8px; color: #90a4ae; font-size: 11px;">Y√ºkleniyor...</div>
                        </div>
                    </div>
                    <label>S√∂zle≈üme Tarihi</label>
                    <input type="date" id="bildirge_sozlesme_tarihi" placeholder="S√∂zle≈üme ba≈ülangƒ±√ß">
                    <label class="required">Yeni Kira Ge√ßerlilik Tarihi</label>
                    <input type="date" id="bildirge_gecerlilik_tarihi" required>
                    <label class="required">Aylƒ±k Kira (KDV hari√ß, TL)</label>
                    <input type="number" step="0.01" id="bildirge_kira_net" placeholder="√ñrn: 528">
                    <label>KDV Oranƒ± (%)</label>
                    <input type="number" id="bildirge_kdv_oran" value="20" min="0" max="100" step="0.01">
                    <label>Hizmet t√ºr√º</label>
                    <select id="bildirge_hizmet_turu" style="width: 100%;">
                        <option value="sanal_ofis">Sanal Ofis</option>
                        <option value="hazir_ofis">Hazƒ±r Ofis</option>
                        <option value="paylasimli_ofis">Payla≈üƒ±mlƒ± Ofis</option>
                        <option value="oda">Oda</option>
                    </select>
                </div>
                <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                    <button type="button" onclick="kiraBildirgesiOnizle()" style="background: #7e57c2; color: white; border: none; padding: 10px 20px; border-radius: 3px; cursor: pointer; font-size: 13px;">
                        üëÅ √ñnizle
                    </button>
                    <button type="button" onclick="kiraBildirgesiYazdir()" style="background: #00bcd4; color: white; border: none; padding: 10px 20px; border-radius: 3px; cursor: pointer; font-size: 13px;">
                        üñ® Yazdƒ±r
                    </button>
                    <button type="button" onclick="kiraBildirgesiWhatsApp()" style="background: #25d366; color: white; border: none; padding: 10px 20px; border-radius: 3px; cursor: pointer; font-size: 13px;">
                        üì± WhatsApp'tan G√∂nder
                    </button>
                </div>
            </div>
        </div>
   </div>
</div>
<script>
let selectedId = null;
let musteriler = [];
let yukluDosyalar = [];

// Sekme deƒüi≈ütirme
function switchTab(index) {
    document.querySelectorAll('.tab').forEach((t, i) => {
        if (i === index) {
            t.classList.add('active');
        } else {
            t.classList.remove('active');
        }
    });
    
    document.querySelectorAll('.tab-content').forEach((c, i) => {
        if (i === index) {
            c.classList.add('active');
        } else {
            c.classList.remove('active');
        }
    });
    // Kira Bildirgesi sekmesine ge√ßince m√º≈üteri ve s√∂zle≈üme tarihini formdan al
    if (index === 2) {
        const ad = document.getElementById('name');
        const soz = document.getElementById('sozlesme_baslangic');
        if (document.getElementById('bildirge_musteri_adi')) document.getElementById('bildirge_musteri_adi').value = ad ? ad.value : '';
        if (document.getElementById('bildirge_sozlesme_tarihi')) document.getElementById('bildirge_sozlesme_tarihi').value = soz ? soz.value : '';
    }
}

// Tamamlanma y√ºzdesini hesapla
function hesaplaYuzde() {
    const zorunluAlanlar = [
        'name', 'tax_number', 'address', 'yetkili_ad'
    ];
    
    const opsiyonelAlanlar = [
        'vergi_dairesi', 'mersis', 'ticaret_sicil', 'kurulus_tarihi',
        'faaliyet', 'nace', 'onceki_adres', 'sube_merkez',
        'yetkili_tc', 'phone', 'phone2', 'email', 'email_sirket',
        'hizmet_turu', 'aylik_kira', 'sozlesme_baslangic', 'sozlesme_bitis',
        'ev_imza_sirk√ºleri', 'ev_vergi_levhasi', 'ev_ticaret_sicil',
        'ev_faaliyet_belgesi', 'ev_ikametgah', 'ev_kase_ornegi'
    ];
    
    let doluZorunlu = 0;
    let doluOpsiyonel = 0;
    
    // Zorunlu alanlarƒ± kontrol et
    zorunluAlanlar.forEach(id => {
        const elem = document.getElementById(id);
        if (elem && elem.value.trim() !== '') {
            doluZorunlu++;
        }
    });
    
    // Opsiyonel alanlarƒ± kontrol et
    opsiyonelAlanlar.forEach(id => {
        const elem = document.getElementById(id);
        if (elem) {
            if (elem.type === 'checkbox') {
                if (elem.checked) doluOpsiyonel++;
            } else if (elem.value && elem.value.trim() !== '') {
                doluOpsiyonel++;
            }
        }
    });
    
    // Y√ºzde hesapla (zorunlu %60, opsiyonel %40)
    const zorunluYuzde = (doluZorunlu / zorunluAlanlar.length) * 60;
    const opsiyonelYuzde = (doluOpsiyonel / opsiyonelAlanlar.length) * 40;
    const toplamYuzde = Math.round(zorunluYuzde + opsiyonelYuzde);
    
    // Progress bar g√ºncelle
    const fill = document.getElementById('completion-fill');
    fill.style.width = toplamYuzde + '%';
    fill.textContent = toplamYuzde + '%';
    
    return toplamYuzde;
}

// M√º≈üteri ara
async function musteriAra() {
    const arama = document.getElementById('arama-input').value.trim();
    
    try {
        const response = await fetch(`/giris/api/musteriler?q=${encodeURIComponent(arama)}`);
        musteriler = await response.json();
        
        const liste = document.getElementById('musteri-liste');
        
        if (musteriler.length === 0) {
            liste.innerHTML = '<div style="padding: 20px; text-align: center; color: #6b7280; font-size: 12px;">M√º≈üteri bulunamadƒ±</div>';
            return;
        }
        
        liste.innerHTML = musteriler.map(m => `
            <div class="musteri-item" onclick="selectMusteri(${m.id})">
                <div class="name">${m.name}</div>
                <div class="vergi">${m.tax_number || 'Vergi no yok'}</div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Hata:', error);
    }
}

// M√º≈üteri se√ß
function selectMusteri(id) {
    const musteri = musteriler.find(m => m.id === id);
    if (!musteri) return;
    
    selectedId = id;
    
    // Se√ßili g√∂ster
    document.querySelectorAll('.musteri-item').forEach(item => {
        item.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
    
    // Formu doldur
    document.getElementById('musteri-id').value = musteri.id;
    document.getElementById('name').value = musteri.name || '';
    document.getElementById('tax_number').value = musteri.tax_number || '';
    document.getElementById('phone').value = musteri.phone || '';
    document.getElementById('email').value = musteri.email || '';
    document.getElementById('address').value = musteri.address || '';
    document.getElementById('notes').value = musteri.notes || '';
    
    // Y√ºzde hesapla
    hesaplaYuzde();
}

// Kaydet
async function kaydet(event) {
    event.preventDefault();
    
    const data = {
        id: document.getElementById('musteri-id').value || null,
        name: document.getElementById('name').value,
        tax_number: document.getElementById('tax_number').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        address: document.getElementById('address').value,
        notes: document.getElementById('notes').value
    };
    
    try {
        const response = await fetch('/giris/kaydet', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.ok) {
            alert(result.mesaj);
            musteriAra();
            if (result.id) {
                selectedId = result.id;
                document.getElementById('musteri-id').value = result.id;
            }
        } else {
            alert(result.mesaj);
        }
        
    } catch (error) {
        alert('‚ùå Hata: ' + error.message);
    }
}

// Dosya y√ºkle
async function dosyaYukle() {
    if (!selectedId) {
        alert('L√ºtfen √∂nce m√º≈üteri se√ßin veya kaydedin!');
        return;
    }
    
    const fileInput = document.getElementById('file-input');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch(`/giris/resim-yukle/${selectedId}`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.ok) {
            alert(result.mesaj);
            yukluDosyalar.push(result.filename);
            dosyaListesiGuncelle();
        } else {
            alert(result.mesaj);
        }
        
    } catch (error) {
        alert('‚ùå Hata: ' + error.message);
    }
    
    fileInput.value = '';
}

// Dosya listesini g√ºncelle
function dosyaListesiGuncelle() {
    const liste = document.getElementById('dosya-liste');
    
    if (yukluDosyalar.length === 0) {
        liste.innerHTML = '';
        return;
    }
    
    liste.innerHTML = yukluDosyalar.map((dosya, index) => `
        <div class="dosya-item">
            <span>${dosya}</span>
            <button onclick="dosyaSil(${index})">üóë</button>
        </div>
    `).join('');
}

// Dosya sil
function dosyaSil(index) {
    if (confirm('Bu dosyayƒ± silmek istediƒüinizden emin misiniz?')) {
        yukluDosyalar.splice(index, 1);
        dosyaListesiGuncelle();
    }
}

// S√∂zle≈üme olu≈ütur
async function sozlesmeOlustur() {
    if (!selectedId) {
        alert('L√ºtfen √∂nce bir m√º≈üteri se√ßin!');
        return;
    }
    const turSelect = document.getElementById('hizmet_turu');
    const tur = turSelect ? turSelect.value : '';
    const encoded = encodeURIComponent(tur);
    window.open(`/giris/sozlesme-olustur/${selectedId}?tur=${encoded}`, '_blank');
}

// Yazdƒ±r
function yazdir() {
    if (!selectedId) {
        alert('L√ºtfen √∂nce bir m√º≈üteri se√ßin!');
        return;
    }
    
    window.print();
}

// Sil
async function sil() {
    if (!selectedId) {
        alert('L√ºtfen silinecek m√º≈üteriyi se√ßin!');
        return;
    }
    
    if (!confirm('Bu m√º≈üteriyi silmek istediƒüinizden emin misiniz?')) {
        return;
    }
    
    try {
        const response = await fetch(`/giris/sil/${selectedId}`, {method: 'POST'});
        const result = await response.json();
        
        if (result.ok) {
            alert(result.mesaj);
            temizleForm();
            musteriAra();
        } else {
            alert(result.mesaj);
        }
        
    } catch (error) {
        alert('‚ùå Hata: ' + error.message);
    }
}

// Temizle
function temizle() {
    document.getElementById('arama-input').value = '';
    document.getElementById('musteri-liste').innerHTML = '<div style="padding: 20px; text-align: center; color: #6b7280; font-size: 12px;">M√º≈üteri arayƒ±n</div>';
    temizleForm();
}

function temizleForm() {
    document.getElementById('musteri-form').reset();
    document.getElementById('musteri-id').value = '';
    selectedId = null;
    yukluDosyalar = [];
    document.querySelectorAll('.musteri-item').forEach(item => {
        item.classList.remove('selected');
    });
    dosyaListesiGuncelle();
    hesaplaYuzde();
}
// Yeni m√º≈üteri formu a√ß
function yeniMusteri() {
    temizleForm();
    alert('Yeni m√º≈üteri formu temizlendi. Bilgileri doldurun ve Kaydet butonuna basƒ±n.');
}

// Sayfa y√ºklendiƒüinde
document.addEventListener('DOMContentLoaded', () => {
    musteriAra();
    hesaplaYuzde();
});
// Kira Senaryo Hesaplama (Basit - Her yƒ±l aynƒ± ay T√úFE'si)
async function kiraSenaryo() {
    const baslangicKira = parseFloat(document.getElementById('senaryo_baslangic_kira').value);
    const baslangicTarih = document.getElementById('senaryo_baslangic_tarih').value;
    const yilSayisi = parseInt(document.getElementById('senaryo_yil_sayisi').value);
    
    if (!baslangicKira || !baslangicTarih || !yilSayisi) {
        alert('L√ºtfen t√ºm zorunlu alanlarƒ± doldurun!');
        return;
    }
    
    try {
        // T√úFE verilerini getir
        const tufeResponse = await fetch('/giris/api/tufe-verileri');
        const tufeVerileri = await tufeResponse.json();
        
        if (tufeVerileri.error) {
            alert('‚ùå T√úFE verileri alƒ±namadƒ±!');
            return;
        }
        
        // Ay adƒ±ndan ay numarasƒ±na √ßevirme
        const ayMap = {
            'Ocak': 1, '≈ûubat': 2, 'Mart': 3, 'Nisan': 4, 'Mayƒ±s': 5, 'Haziran': 6,
            'Temmuz': 7, 'Aƒüustos': 8, 'Eyl√ºl': 9, 'Ekim': 10, 'Kasƒ±m': 11, 'Aralƒ±k': 12
        };
        
        // T√úFE verilerini organize et: {2022: {Mart: 68.5, ...}}
        const tufeListe = {};
        tufeVerileri.forEach(v => {
            if (!tufeListe[v.yil]) tufeListe[v.yil] = {};
            tufeListe[v.yil][v.ay] = v.oran;
        });
        
        // Ba≈ülangƒ±√ß tarihini parse et
        const baslangic = new Date(baslangicTarih);
        const baslangicYil = baslangic.getFullYear();
        const baslangicAy = baslangic.getMonth() + 1; // 0-11 ‚Üí 1-12
        
        // S√∂zle≈üme ayƒ± adƒ±
        const sozlesmeAyAdi = Object.keys(ayMap).find(key => ayMap[key] === baslangicAy);
        
        // ≈ûu anki tarih
        const bugun = new Date();
        const suAnkiYil = bugun.getFullYear();
        const suAnkiAy = bugun.getMonth() + 1;
        
        let tablo = '';
        let toplamYilliklar = 0;
        let toplamArtislar = 0;
        let mevcutKira = baslangicKira;
        
        for (let i = 0; i < yilSayisi; i++) {
            const yil = baslangicYil + i;
            
            // Bu yƒ±lƒ±n s√∂zle≈üme ayƒ± geldi mi kontrol et
            if (yil === suAnkiYil && suAnkiAy < baslangicAy) {
                // Hen√ºz s√∂zle≈üme ayƒ± gelmedi, hesaplama yapma!
                break;
            } else if (yil > suAnkiYil) {
                // Gelecek yƒ±l, hesaplama yapma!
                break;
            }
            
            const yillikToplam = mevcutKira * 12;
            toplamYilliklar += yillikToplam;
            
            // ƒ∞lk yƒ±l artƒ±≈ü yok
            let artisOran = 0;
            let artisTutar = 0;
            
            if (i > 0) {
                let tufeOran = 0;
                if (tufeListe[yil] && tufeListe[yil][sozlesmeAyAdi]) {
                    tufeOran = tufeListe[yil][sozlesmeAyAdi] / 100;
                }
                
                const eskiKira = mevcutKira / (1 + tufeOran);
                artisOran = tufeOran * 100;
                artisTutar = mevcutKira - eskiKira;
                toplamArtislar += artisTutar;
            }
            
            tablo += `
                <tr style="border-bottom: 1px solid #2d4060;">
                    <td style="padding: 8px; color: #e0f7fa; font-size: 11px;">${yil}</td>
                    <td style="padding: 8px; text-align: right; color: #e0f7fa; font-size: 11px;">${mevcutKira.toLocaleString('tr-TR', {minimumFractionDigits: 2})} TL</td>
                    <td style="padding: 8px; text-align: right; color: #4fc3f7; font-weight: bold; font-size: 11px;">${yillikToplam.toLocaleString('tr-TR', {minimumFractionDigits: 2})} TL</td>
                    <td style="padding: 8px; text-align: right; color: #ff9800; font-size: 11px;">${artisOran.toFixed(2)}%</td>
                    <td style="padding: 8px; text-align: right; color: #4caf50; font-size: 11px;">${artisTutar.toLocaleString('tr-TR', {minimumFractionDigits: 2})} TL</td>
                </tr>
            `;
            
            if (i < yilSayisi - 1) {
                let tufeOran = 0;
                if (tufeListe[yil] && tufeListe[yil][sozlesmeAyAdi]) {
                    tufeOran = tufeListe[yil][sozlesmeAyAdi] / 100;
                    mevcutKira = mevcutKira * (1 + tufeOran);
                }
            }
        }
        
        // Toplam satƒ±rƒ±
        tablo += `
            <tr style="background: #0097a7; font-weight: bold;">
                <td style="padding: 8px; color: white; font-size: 11px;">TOPLAM</td>
                <td style="padding: 8px; text-align: right; color: white; font-size: 11px;">-</td>
                <td style="padding: 8px; text-align: right; color: white; font-size: 11px;">${toplamYilliklar.toLocaleString('tr-TR', {minimumFractionDigits: 2})} TL</td>
                <td style="padding: 8px; text-align: right; color: white; font-size: 11px;">-</td>
                <td style="padding: 8px; text-align: right; color: white; font-size: 11px;">${toplamArtislar.toLocaleString('tr-TR', {minimumFractionDigits: 2})} TL</td>
            </tr>
        `;
        
        document.getElementById('senaryo-tablo').innerHTML = tablo;
        document.getElementById('senaryo-toplam-yil').textContent = yilSayisi;
        document.getElementById('senaryo-toplam-tutar').textContent = toplamYilliklar.toLocaleString('tr-TR', {minimumFractionDigits: 2});
        document.getElementById('senaryo-sonuc').style.display = 'block';
        
    } catch (error) {
        alert('‚ùå Hata: ' + error.message);
    }
}
// Senaryo Temizle
function senaryoTemizle() {
    document.getElementById('senaryo_baslangic_kira').value = '';
    document.getElementById('senaryo_baslangic_tarih').value = '';
    document.getElementById('senaryo_yil_sayisi').value = '5';
    document.getElementById('senaryo_tufe').value = '65.0';
    document.getElementById('senaryo-sonuc').style.display = 'none';
}
// TCMB T√úFE Verileri G√∂ster
async function tufeVerileri() {
    try {
        const response = await fetch('/giris/api/tufe-verileri');
        const veriler = await response.json();
        
        if (veriler.error) {
            alert('‚ùå Hata: ' + veriler.error);
            return;
        }
        
        let html = '<div style="background: #0f2537; padding: 15px; border-radius: 4px; max-height: 400px; overflow-y: auto;">';
        html += '<h4 style="color: #4fc3f7; margin: 0 0 10px 0;">TCMB T√úFE Verileri (Son 60 Ay)</h4>';
        html += '<table style="width: 100%; border-collapse: collapse;">';
        html += '<thead><tr style="background: #0097a7; color: white;">';
        html += '<th style="padding: 8px; text-align: left;">Yƒ±l</th>';
        html += '<th style="padding: 8px; text-align: left;">Ay</th>';
        html += '<th style="padding: 8px; text-align: right;">T√úFE (%)</th>';
        html += '</tr></thead><tbody>';
        
        veriler.forEach(v => {
            html += `<tr style="border-bottom: 1px solid #2d4060;">
                <td style="padding: 8px; color: #e0f7fa;">${v.yil}</td>
                <td style="padding: 8px; color: #e0f7fa;">${v.ay}</td>
                <td style="padding: 8px; text-align: right; color: #4fc3f7; font-weight: bold;">${v.oran.toFixed(2)}%</td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;';
        modal.innerHTML = `
            <div style="background: #1e3a50; padding: 20px; border-radius: 8px; max-width: 600px; width: 90%;">
                ${html}
                <button onclick="this.closest('div[style*=fixed]').remove()" style="margin-top: 15px; background: #6b7280; color: white; border: none; padding: 10px 30px; border-radius: 3px; cursor: pointer; width: 100%;">
                    Kapat
                </button>
            </div>
        `;
        document.body.appendChild(modal);
        
    } catch (error) {
        alert('‚ùå Hata: ' + error.message);
    }
}

// Excel ƒ∞ndir
async function excelIndir() {
    const baslangicKira = document.getElementById('senaryo_baslangic_kira').value;
    const baslangicTarih = document.getElementById('senaryo_baslangic_tarih').value;
    const yilSayisi = document.getElementById('senaryo_yil_sayisi').value;
    const tufeOran = 65; // Varsayƒ±lan T√úFE (Excel i√ßin)
    
    if (!baslangicKira || !baslangicTarih || !yilSayisi) {
        alert('L√ºtfen √∂nce hesaplama yapƒ±n!');
        return;
    }
    
    try {
        const response = await fetch('/giris/api/kira-senaryo-excel', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                baslangic_kira: baslangicKira,
                baslangic_tarih: baslangicTarih,
                yil_sayisi: yilSayisi,
                tufe_oran: tufeOran
            })
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Kira_Senaryo_${new Date().getTime()}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } else {
            alert('‚ùå Excel olu≈üturulamadƒ±!');
        }
        
    } catch (error) {
        alert('‚ùå Hata: ' + error.message);
    }
}

// ‚îÄ‚îÄ Kira Bildirgesi ‚îÄ‚îÄ
function bildirgeMusteriListeToggle() {
    const el = document.getElementById('bildirge_musteri_liste');
    if (el.style.display === 'none') {
        el.style.display = 'block';
        el.innerHTML = '<div style="padding:8px;color:#90a4ae;font-size:11px;">Y√ºkleniyor...</div>';
        fetch('/giris/api/musteriler')
            .then(r => r.json())
            .then(arr => {
                if (!arr.length) {
                    el.innerHTML = '<div style="padding:8px;color:#90a4ae;">M√º≈üteri bulunamadƒ±.</div>';
                    return;
                }
                el.innerHTML = arr.map(m => '<div class="bildirge-musteri-item" style="padding:8px 12px;cursor:pointer;border-bottom:1px solid #2d4060;" data-name="' + (m.name || '').replace(/"/g, '&quot;') + '">' + (m.name || '‚Äî') + '</div>').join('');
                el.querySelectorAll('.bildirge-musteri-item').forEach(item => {
                    item.onclick = function() {
                        document.getElementById('bildirge_musteri_adi').value = this.getAttribute('data-name') || this.textContent;
                        el.style.display = 'none';
                    };
                });
            })
            .catch(() => { el.innerHTML = '<div style="padding:8px;color:#f44336;">Y√ºklenemedi.</div>'; });
    } else {
        el.style.display = 'none';
    }
}
document.addEventListener('click', function(e) {
    const list = document.getElementById('bildirge_musteri_liste');
    if (!list || list.style.display === 'none') return;
    if (list.contains(e.target)) return;
    if (e.target.id === 'bildirge_musteri_adi' || e.target.closest('button[onclick*="bildirgeMusteriListeToggle"]')) return;
    list.style.display = 'none';
});
function kiraBildirgesiPayload() {
    const gecerlilik = document.getElementById('bildirge_gecerlilik_tarihi').value;
    const kiraNet = parseFloat((document.getElementById('bildirge_kira_net').value || '').replace(',', '.')) || 0;
    const kdv = parseFloat((document.getElementById('bildirge_kdv_oran').value || '20').replace(',', '.')) || 20;
    const hizmetTuru = (document.getElementById('bildirge_hizmet_turu') || {}).value || 'sanal_ofis';
    return {
        musteri_adi: (document.getElementById('bildirge_musteri_adi').value || '').trim() || 'Deƒüerli Kiracƒ±mƒ±z',
        sozlesme_tarihi: document.getElementById('bildirge_sozlesme_tarihi').value || '',
        gecerlilik_tarihi: gecerlilik,
        kira_net: kiraNet,
        kdv_oran: kdv,
        hizmet_turu: hizmetTuru
    };
}
async function kiraBildirgesiPdfBlob() {
    const payload = kiraBildirgesiPayload();
    if (!payload.gecerlilik_tarihi) {
        alert('L√ºtfen yeni kira ge√ßerlilik tarihini giriniz.');
        return null;
    }
    if (payload.kira_net <= 0) {
        alert('L√ºtfen aylƒ±k kira tutarƒ±nƒ± giriniz.');
        return null;
    }
    const response = await fetch('/giris/kira-bildirgesi-pdf', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
    if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        alert(err.mesaj || 'PDF olu≈üturulamadƒ±.');
        return null;
    }
    return await response.blob();
}
async function kiraBildirgesiOnizle() {
    const blob = await kiraBildirgesiPdfBlob();
    if (blob) {
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank', 'noopener');
    }
}
async function kiraBildirgesiYazdir() {
    const blob = await kiraBildirgesiPdfBlob();
    if (blob) {
        const url = URL.createObjectURL(blob);
        const w = window.open(url, '_blank', 'noopener');
        if (w) w.focus();
    }
}
async function kiraBildirgesiWhatsApp() {
    const blob = await kiraBildirgesiPdfBlob();
    if (!blob) return;
    const payload = kiraBildirgesiPayload();
    const tel = (document.getElementById('phone').value || '').replace(/\D/g, '');
    const num = tel.startsWith('0') ? '90' + tel.slice(1) : (tel ? '90' + tel : '');
    const metin = encodeURIComponent(
        'Sayƒ±n ' + (payload.musteri_adi || 'Kiracƒ±mƒ±z') + ',\n\n' +
        'Kira bildirgemiz ekte yer almaktadƒ±r. ƒ∞ncelemenizi rica ederiz.\n\nƒ∞yi g√ºnler dileriz.\nBESTOFFICE'
    );
    const url = num ? `https://wa.me/${num}?text=${metin}` : `https://wa.me/?text=${metin}`;
    window.open(url, '_blank', 'noopener');
}
</script>
{% endblock %}
