{% extends "layout.html" %}

{% block page_title %}Personel{% endblock %}

{% block content %}
<style>
.personel-header {
    background: #0f2537;
    padding: 12px;
    margin: -10px -10px 10px -10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.personel-header h2 {
    color: #4fc3f7;
    margin: 0;
    font-size: 16px;
}
.personel-buttons button {
    background: #00bcd4;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 13px;
    margin-left: 8px;
}
.personel-grid {
    width: 100%;
    background: #243447;
    border-collapse: collapse;
    font-size: 12px;
}
.personel-grid th {
    background: #0097a7;
    color: white;
    padding: 8px;
    text-align: left;
    font-size: 11px;
}
.personel-grid td {
    padding: 8px;
    border-bottom: 1px solid #2d4060;
    color: #e0f7fa;
}
.personel-grid tr:hover {
    background: #2d4060;
    cursor: pointer;
}
.pere-box { background: #12243a; border: 1px solid #1e3a5f; border-radius: 8px; padding: 14px; margin-bottom: 12px; }
.btn-pere { background: #00bcd4; color: #000; border: none; padding: 8px 14px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; margin-right: 6px; margin-bottom: 6px; }
.btn-pere:hover { background: #29b6f6; }
.btn-pere.secondary { background: #546e7a; color: #fff; }
.btn-pere.danger { background: #ef5350; color: #fff; }
@media (max-width: 900px) { .personel-page { grid-template-columns: 1fr !important; } }
</style>

<div class="personel-header">
    <h2>ðŸ‘¥ Personel Devam Takip & YÃ¶netim</h2>
    <div class="personel-buttons">
        <button onclick="yeniPersonel()">âž• Yeni Personel</button>
        <button onclick="yenile()">â†º Yenile</button>
    </div>
</div>

<div class="personel-page" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
  <div class="pere-box" style="background:#12243a; border:1px solid #1e3a5f; border-radius:8px; padding:14px;">
    <h3 style="color:#4fc3f7; margin:0 0 10px 0; font-size:14px;">Personel YÃ¶netimi</h3>
    <input type="hidden" id="fPersonelId" />
    <label style="display:block; color:#888; font-size:12px;">Ad Soyad</label>
    <input type="text" id="fAdSoyad" style="width:100%; background:#0a1929; border:1px solid #1e3a5f; color:#e0f7fa; padding:6px 10px; margin-bottom:10px; border-radius:4px;" placeholder="Ad Soyad" />
    <label style="display:block; color:#888; font-size:12px;">Mesai BaÅŸlangÄ±Ã§</label>
    <input type="time" id="fMesai" value="09:00" style="width:100%; background:#0a1929; border:1px solid #1e3a5f; color:#e0f7fa; padding:6px; margin-bottom:10px; border-radius:4px;" />
    <label style="display:block; color:#888; font-size:12px;">Durum</label>
    <select id="fAktif" style="width:100%; background:#0a1929; border:1px solid #1e3a5f; color:#e0f7fa; padding:6px; margin-bottom:10px; border-radius:4px;"><option value="1">Aktif</option><option value="0">Pasif</option></select>
    <label style="display:block; color:#888; font-size:12px;">MAC Adres</label>
    <input type="text" id="fMac" placeholder="AA:BB:CC:DD:EE:FF" style="width:100%; background:#0a1929; border:1px solid #1e3a5f; color:#e0f7fa; padding:6px; margin-bottom:10px; border-radius:4px;" />
    <label style="display:block; color:#888; font-size:12px;">Not</label>
    <textarea id="fNotlar" placeholder="Not / DeÄŸerlendirme" style="width:100%; min-height:50px; background:#0a1929; border:1px solid #1e3a5f; color:#e0f7fa; padding:6px; margin-bottom:10px; border-radius:4px;"></textarea>
    <div style="margin-bottom:10px;">
      <button type="button" class="btn-pere" onclick="personelKaydet()">+ Ekle / GÃ¼ncelle</button>
      <button type="button" class="btn-pere secondary" onclick="personelAktifYap()">Aktif Yap</button>
      <button type="button" class="btn-pere danger" onclick="personelPasifeAl()">Pasife Al</button>
      <button type="button" class="btn-pere secondary" onclick="formTemizle()">Temizle</button>
    </div>
    <div style="margin-bottom:8px;"><span style="color:#888; font-size:12px;">GÃ¶ster:</span>
      <label style="margin-left:10px;"><input type="radio" name="filtre" value="tumu" /> TÃ¼mÃ¼</label>
      <label style="margin-left:8px;"><input type="radio" name="filtre" value="aktif" checked /> Aktif</label>
      <label style="margin-left:8px;"><input type="radio" name="filtre" value="pasif" /> Pasif</label>
    </div>
    <div style="overflow:auto; max-height:280px;">
      <table class="personel-grid" id="personelListeTbl">
        <thead><tr><th>Personel AdÄ±</th><th>Mesai</th><th>Durum</th><th>Not</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <div class="pere-box" style="background:#12243a; border:1px solid #1e3a5f; border-radius:8px; padding:14px;">
    <h3 style="color:#4fc3f7; margin:0 0 10px 0; font-size:14px;">GÃ¼nlÃ¼k Devam Listesi</h3>
    <div style="margin-bottom:10px;">
      <input type="date" id="devamTarih" style="margin-right:8px; padding:6px; background:#0a1929; border:1px solid #1e3a5f; color:#e0f7fa; border-radius:4px;" />
      <button type="button" class="btn-pere" onclick="devamBugun()">BugÃ¼n</button>
      <button type="button" class="btn-pere secondary" onclick="devamYenile()">Yenile</button>
    </div>
    <div style="overflow:auto; max-height:200px; margin-bottom:12px;">
      <table class="personel-grid" id="gunlukDevamTbl">
        <thead><tr><th>Personel</th><th>GiriÅŸ</th><th>Ã‡Ä±kÄ±ÅŸ</th><th>Durum</th><th>GeÃ§ (dk)</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <h3 style="color:#4fc3f7; margin:10px 0 8px 0; font-size:13px;">Manuel DÃ¼zeltme</h3>
    <select id="devamPersonel" style="width:100%; margin-bottom:8px; padding:6px; background:#0a1929; border:1px solid #1e3a5f; color:#e0f7fa;"></select>
    <input type="time" id="devamGiris" style="width:48%; margin-right:4%; padding:6px; margin-bottom:8px;" />
    <input type="time" id="devamCikis" style="width:48%; padding:6px; margin-bottom:8px;" />
    <button type="button" class="btn-pere" onclick="devamKaydet()">Kaydet</button>
    <h3 style="color:#4fc3f7; margin:14px 0 8px 0; font-size:13px;">AylÄ±k Ã–zet</h3>
    <div style="margin-bottom:8px;">
      <input type="number" id="aylikYil" min="2020" max="2030" style="width:70px; padding:6px; margin-right:6px;" />
      <select id="aylikAy" style="width:60px; padding:6px; margin-right:6px;"></select>
      <button type="button" class="btn-pere" onclick="aylikYenile()">GÃ¶ster</button>
    </div>
    <div style="overflow:auto; max-height:180px;">
      <table class="personel-grid" id="aylikOzetTbl">
        <thead><tr><th>Personel</th><th>Toplam GÃ¼n</th><th>GeÃ§ SayÄ±sÄ±</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
var API_LIST = "{{ url_for('personel.api_list') }}";
var API_KAYDET = "{{ url_for('personel.api_personel_kaydet') }}";
var API_DEVAM_GUNLUK = "{{ url_for('personel.api_devam_gunluk') }}";
var API_DEVAM_AYLIK = "{{ url_for('personel.api_devam_aylik') }}";
var API_DEVAM_KAYDET = "{{ url_for('personel.api_devam_kaydet') }}";

function getFiltre() { var r = document.querySelector('input[name="filtre"]:checked'); return r ? r.value : 'aktif'; }

function yeniPersonel() { formTemizle(); document.getElementById('fAdSoyad').focus(); }

function yenile() { personelListeYukle(); devamYenile(); aylikYenile(); }

function personelListeYukle() {
  fetch(API_LIST + '?filtre=' + getFiltre()).then(r => r.json()).then(arr => {
    var tbody = document.querySelector('#personelListeTbl tbody');
    tbody.innerHTML = '';
    arr.forEach(function(p) {
      var tr = document.createElement('tr');
      tr.innerHTML = '<td><strong>' + (p.ad_soyad || '') + '</strong></td><td>' + (p.mesai_baslangic || '09:00') + '</td><td>' + (p.is_active ? 'Aktif' : 'Pasif') + '</td><td>' + (p.notlar || '').substring(0, 25) + '</td><td><button class="personel-buttons button" style="padding:4px 8px; font-size:11px;" onclick="duzenle(' + p.id + ')">DÃ¼zenle</button></td>';
      tbody.appendChild(tr);
    });
    if (arr.length === 0) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#888;">KayÄ±t yok</td></tr>';
  });
}

function duzenle(id) {
  fetch(API_LIST + '?filtre=tumu').then(r => r.json()).then(arr => {
    var p = arr.find(function(x){ return x.id === id; });
    if (!p) return;
    document.getElementById('fPersonelId').value = p.id;
    document.getElementById('fAdSoyad').value = p.ad_soyad || '';
    document.getElementById('fMesai').value = (p.mesai_baslangic || '09:00').substring(0,5);
    document.getElementById('fAktif').value = p.is_active ? '1' : '0';
    document.getElementById('fMac').value = p.mac_adres || '';
    document.getElementById('fNotlar').value = p.notlar || '';
    document.getElementById('fAdSoyad').focus();
  });
}

function formTemizle() {
  document.getElementById('fPersonelId').value = '';
  document.getElementById('fAdSoyad').value = '';
  document.getElementById('fMesai').value = '09:00';
  document.getElementById('fAktif').value = '1';
  document.getElementById('fMac').value = '';
  document.getElementById('fNotlar').value = '';
}

function personelKaydet() {
  var id = document.getElementById('fPersonelId').value;
  var ad_soyad = document.getElementById('fAdSoyad').value.trim();
  if (!ad_soyad) { alert('Ad soyad zorunlu'); return; }
  var payload = { ad_soyad: ad_soyad, pozisyon: '', telefon: '', email: '', mesai_baslangic: document.getElementById('fMesai').value || '09:00', is_active: document.getElementById('fAktif').value === '1', mac_adres: document.getElementById('fMac').value.trim(), notlar: document.getElementById('fNotlar').value.trim() };
  if (id) payload.id = parseInt(id, 10);
  fetch(API_KAYDET, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
    .then(r => r.json()).then(function(d) { if (d.ok) { personelListeYukle(); if (!id) formTemizle(); } else alert(d.mesaj || 'Hata'); }).catch(function(e) { alert('Hata: ' + e); });
}

function personelAktifYap() {
  var id = document.getElementById('fPersonelId').value;
  if (!id) { alert('Ã–nce personel seÃ§in'); return; }
  fetch(API_KAYDET, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: parseInt(id,10), ad_soyad: document.getElementById('fAdSoyad').value.trim(), pozisyon: '', telefon: '', email: '', mesai_baslangic: document.getElementById('fMesai').value || '09:00', mac_adres: document.getElementById('fMac').value, notlar: document.getElementById('fNotlar').value, is_active: true }) })
    .then(r => r.json()).then(function(d) { if (d.ok) { personelListeYukle(); document.getElementById('fAktif').value = '1'; } });
}

function personelPasifeAl() {
  var id = document.getElementById('fPersonelId').value;
  if (!id) { alert('Ã–nce personel seÃ§in'); return; }
  if (!confirm('Pasife alÄ±nsÄ±n mÄ±?')) return;
  fetch(API_KAYDET, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: parseInt(id,10), ad_soyad: document.getElementById('fAdSoyad').value.trim(), pozisyon: '', telefon: '', email: '', mesai_baslangic: document.getElementById('fMesai').value || '09:00', mac_adres: document.getElementById('fMac').value, notlar: document.getElementById('fNotlar').value, is_active: false }) })
    .then(r => r.json()).then(function(d) { if (d.ok) { personelListeYukle(); formTemizle(); } });
}

function devamBugun() {
  var d = new Date();
  document.getElementById('devamTarih').value = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
  devamYenile();
}

function devamYenile() {
  var tarih = document.getElementById('devamTarih').value;
  fetch(API_DEVAM_GUNLUK + (tarih ? '?tarih=' + tarih : '')).then(r => r.json()).then(arr => {
    var tbody = document.querySelector('#gunlukDevamTbl tbody');
    tbody.innerHTML = '';
    arr.forEach(function(r) { var tr = document.createElement('tr'); tr.innerHTML = '<td>' + (r.ad_soyad || '') + '</td><td>' + (r.giris_saati || 'â€”') + '</td><td>' + (r.cikis_saati || 'â€”') + '</td><td>' + (r.durum || '') + '</td><td>' + (r.gec_dakika || 0) + '</td>'; tbody.appendChild(tr); });
    if (arr.length === 0) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#888;">KayÄ±t yok</td></tr>';
  });
  fetch(API_LIST + '?filtre=aktif').then(r => r.json()).then(arr => {
    var sel = document.getElementById('devamPersonel');
    sel.innerHTML = '<option value="">â€” SeÃ§in â€”</option>';
    arr.forEach(function(p) { var o = document.createElement('option'); o.value = p.id; o.textContent = p.ad_soyad; sel.appendChild(o); });
  });
}

function devamKaydet() {
  var personel_id = document.getElementById('devamPersonel').value;
  var tarih = document.getElementById('devamTarih').value;
  if (!personel_id || !tarih) { alert('Personel ve tarih seÃ§in'); return; }
  fetch(API_DEVAM_KAYDET, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ personel_id: parseInt(personel_id,10), tarih: tarih, giris_saati: document.getElementById('devamGiris').value || null, cikis_saati: document.getElementById('devamCikis').value || null }) })
    .then(r => r.json()).then(function(d) { if (d.ok) devamYenile(); else alert(d.mesaj || 'Hata'); });
}

function aylikYenile() {
  var yil = document.getElementById('aylikYil').value || new Date().getFullYear();
  var ay = document.getElementById('aylikAy').value || new Date().getMonth() + 1;
  fetch(API_DEVAM_AYLIK + '?yil=' + yil + '&ay=' + ay).then(r => r.json()).then(arr => {
    var tbody = document.querySelector('#aylikOzetTbl tbody');
    tbody.innerHTML = '';
    arr.forEach(function(r) { var tr = document.createElement('tr'); tr.innerHTML = '<td>' + (r.ad_soyad || '') + '</td><td>' + (r.toplam_gun || 0) + '</td><td>' + (r.gec_sayisi || 0) + '</td>'; tbody.appendChild(tr); });
    if (arr.length === 0) tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#888;">KayÄ±t yok</td></tr>';
  });
}

document.addEventListener('DOMContentLoaded', function() {
  var d = new Date();
  document.getElementById('devamTarih').value = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
  document.getElementById('aylikYil').value = d.getFullYear();
  var aySel = document.getElementById('aylikAy');
  for (var i = 1; i <= 12; i++) { var o = document.createElement('option'); o.value = i; o.textContent = i; aySel.appendChild(o); }
  aySel.value = d.getMonth() + 1;
  personelListeYukle();
  devamYenile();
  aylikYenile();
  document.querySelectorAll('input[name="filtre"]').forEach(function(el) { el.addEventListener('change', personelListeYukle); });
});
</script>
{% endblock %}