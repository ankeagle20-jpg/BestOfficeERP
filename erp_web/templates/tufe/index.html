{% extends "layout.html" %}

{% block page_title %}T√úFE Oranlarƒ±{% endblock %}

{% block content %}
<style>
.tufe-header {
    background: #0f2537;
    padding: 12px 16px;
    margin: -10px -10px 10px -10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.tufe-header h2 {
    color: #4fc3f7;
    margin: 0;
    font-size: 16px;
}
.tufe-buttons {
    display: flex;
    gap: 8px;
}
.tufe-buttons button {
    background: #00bcd4;
    color: white;
    border: none;
    padding: 7px 14px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 13px;
    font-weight: bold;
    transition: background 0.2s;
}
.tufe-buttons button:hover {
    background: #0097a7;
}
.tufe-buttons button.danger {
    background: #546e7a;
}
.tufe-buttons button.danger:hover {
    background: #37474f;
}
.yil-selector {
    background: #1e3a50;
    padding: 10px 12px;
    margin-bottom: 12px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 12px;
}
.yil-selector label {
    color: #b0bec5;
    font-size: 13px;
    font-weight: bold;
}
.yil-selector input {
    background: #2d4060;
    border: 1px solid #3d5070;
    color: #e0f7fa;
    padding: 6px 12px;
    border-radius: 3px;
    font-size: 15px;
    width: 80px;
    text-align: center;
    font-weight: bold;
}
.yil-selector button {
    background: #00bcd4;
    color: white;
    border: none;
    padding: 6px 14px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 13px;
    font-weight: bold;
}
.aylar-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 8px;
}
.ay-kart {
    background: #1e3a50;
    padding: 10px;
    border-radius: 3px;
    border: 1px solid #2d4060;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: all 0.2s;
}
.ay-kart:hover {
    border-color: #00bcd4;
}
.ay-kart h3 {
    color: #90a4ae;
    font-size: 10px;
    margin: 0 0 6px 0;
    text-align: center;
    font-weight: 600;
    text-transform: uppercase;
}
.ay-kart input {
    width: 100%;
    background: #2d4060;
    border: 1px solid #3d5070;
    color: #00bcd4;
    padding: 4px 6px;
    border-radius: 3px;
    font-size: 14px;
    text-align: center;
    font-weight: bold;
    font-family: 'Courier New', monospace;
}
.ay-kart input:focus {
    border-color: #00bcd4;
    outline: none;
}
.ay-kart.veri-var {
    background: #1a3a4a;
    border-color: #0097a7;
}
.ay-kart.veri-yok {
    background: #1e3a50;
    border-color: #37474f;
}
@media (max-width: 1024px) {
    .aylar-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}
@media (max-width: 768px) {
    .aylar-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}
</style>

<div class="tufe-header">
    <h2>üìä T√úFE Oranlarƒ±</h2>
    <div class="tufe-buttons">
        <button onclick="yukle()">‚Ü∫ Y√ºkle</button>
        <button onclick="kaydet()">üíæ Kaydet</button>
        <button onclick="sil()" class="danger">üóë Sil</button>
        <button onclick="tcmbCek()">üåê TCMB'den √áek</button>
    </div>
</div>

<!-- Yƒ±l Se√ßici -->
<form id="tufe-form" method="post" action="{{ url_for('tufe.kaydet') }}">
    <div class="yil-selector">
        <label>Yƒ±l:</label>
        <input type="number" name="yil" value="{{ yil }}" id="tufe-yil" min="2000" max="2100">
        <button type="button" onclick="yilDegistir()">‚ñ∂ G√∂ster</button>
    </div>

    <!-- Aylar Grid (6 s√ºtun x 2 satƒ±r) -->
    <div class="aylar-grid">
        {% for ay in aylar %}
        {% set oran = data.get(ay) %}
        <div class="ay-kart {% if oran is not none %}veri-var{% else %}veri-yok{% endif %}">
            <h3>{{ ay }}</h3>
            <input type="text"
                   name="ay_{{ loop.index }}"
                   id="ay_{{ loop.index }}"
                   placeholder="‚Äî"
                   value="{% if oran is not none %}{{ '%.2f'|format(oran) }}{% endif %}">
        </div>
        {% endfor %}
    </div>
</form>

<script>
const TUFE_INDEX_URL = "{{ url_for('tufe.index') }}";
const TUFE_KAYDET_URL = "{{ url_for('tufe.kaydet') }}";
const TUFE_SIL_URL = "{{ url_for('tufe.sil') }}";
const TUFE_TCMB_URL = "{{ url_for('tufe.tcmb_cek') }}";

function yilDegistir() {
    const yil = document.getElementById('tufe-yil').value;
    window.location.href = TUFE_INDEX_URL + "?yil=" + encodeURIComponent(yil);
}

function yukle() {
    yilDegistir();
}

function kaydet() {
    document.getElementById('tufe-form').submit();
}

async function tcmbCek() {
    if (!confirm('TCMB\'den g√ºncel verileri √ßekmek istiyor musunuz?')) return;
    
    try {
        const res = await fetch(TUFE_TCMB_URL);
        const j = await res.json();
        
        if (j.ok) {
            alert("‚úÖ TCMB verileri g√ºncellendi: " + (j.guncellenen || 0) + " satƒ±r.");
            yilDegistir();
        } else {
            alert("‚ùå Hata: " + (j.hata || "TCMB verileri √ßekilemedi."));
        }
    } catch (e) {
        alert("‚ùå Baƒülantƒ± hatasƒ±: " + e.message);
    }
}

async function sil() {
    const yil = document.getElementById('tufe-yil').value;
    if (!confirm(yil + " yƒ±lƒ± verilerini silmek istiyor musunuz?")) return;
    
    const fd = new FormData();
    fd.append("yil", yil);
    
    // Deƒüer girilmi≈ü aylarƒ± sil
    const aylar = {{ aylar|tojson }};
    for (let i = 1; i <= 12; i++) {
        const inp = document.getElementById("ay_" + i);
        if (inp && inp.value.trim()) {
            fd.append("aylar", aylar[i-1]);
        }
    }
    
    try {
        await fetch(TUFE_SIL_URL, { method: "POST", body: fd });
        alert("‚úÖ Veriler silindi!");
        yilDegistir();
    } catch (e) {
        alert("‚ùå Silme hatasƒ±: " + e.message);
    }
}
</script>
{% endblock %}