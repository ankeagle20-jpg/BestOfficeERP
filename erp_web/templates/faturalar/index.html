{% extends "layout.html" %}

{% block page_title %}Faturalar - Aylık Faturalama{% endblock %}

{% block content %}
<style>
.fatura-header {
    background: #1e3a50;
    padding: 10px 12px;
    margin: -10px -10px 10px -10px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}
.fatura-header label {
    color: #b0bec5;
    font-size: 13px;
}
.fatura-header select {
    background: #2d4060;
    border: 1px solid #3d5070;
    color: #e0f7fa;
    padding: 6px 10px;
    border-radius: 3px;
    font-size: 13px;
}
.fatura-header button {
    background: #00bcd4;
    color: white;
    border: none;
    padding: 7px 14px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 13px;
    font-weight: bold;
}
.fatura-header button.danger {
    background: #e74c3c;
}
.ozet-bar {
    background: #0f2537;
    padding: 10px 12px;
    margin-bottom: 10px;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    color: #4fc3f7;
    font-size: 13px;
    font-weight: bold;
}
.fatura-container {
    display: grid;
    grid-template-columns: 1fr 420px;
    gap: 12px;
}
.firma-liste {
    background: #1e3a50;
    padding: 12px;
    border-radius: 4px;
}
.firma-liste h3 {
    color: #4fc3f7;
    font-size: 14px;
    margin: 0 0 10px 0;
}
.firma-table {
    width: 100%;
    background: #243447;
    border-collapse: collapse;
    font-size: 11px;
}
.firma-table th {
    background: #0097a7;
    color: white;
    padding: 6px 8px;
    text-align: left;
    font-size: 10px;
    position: sticky;
    top: 0;
}
.firma-table td {
    padding: 6px 8px;
    border-bottom: 1px solid #2d4060;
    color: #e0f7fa;
}
.firma-table tr:hover {
    background: #2d4060;
    cursor: pointer;
}
.firma-table tr.selected {
    background: #00695c;
}
.fatura-panel {
    background: #1e3a50;
    padding: 12px;
    border-radius: 4px;
}
.fatura-panel h3 {
    color: #4fc3f7;
    font-size: 14px;
    margin: 0 0 10px 0;
    padding-bottom: 6px;
    border-bottom: 1px solid #2d4060;
}
.secili-firma {
    padding: 10px;
    background: #0f2537;
    border-radius: 3px;
    margin-bottom: 10px;
}
.secili-firma .ad {
    color: #4fc3f7;
    font-weight: bold;
    font-size: 14px;
}
.secili-firma .bilgi {
    color: #90a4ae;
    font-size: 12px;
    margin-top: 4px;
}
.kalem-table {
    width: 100%;
    background: #243447;
    border-collapse: collapse;
    font-size: 11px;
    margin: 10px 0;
}
.kalem-table th {
    background: #0097a7;
    color: white;
    padding: 5px 6px;
    text-align: center;
    font-size: 10px;
}
.kalem-table td {
    padding: 5px 6px;
    border-bottom: 1px solid #2d4060;
    text-align: center;
    color: #e0f7fa;
}
.kalem-ekle {
    display: flex;
    gap: 8px;
    margin: 10px 0;
}
.kalem-ekle input, .kalem-ekle select {
    background: #2d4060;
    border: 1px solid #3d5070;
    color: #e0f7fa;
    padding: 5px 8px;
    border-radius: 3px;
    font-size: 12px;
}
.form-group {
    margin-bottom: 8px;
}
.form-group label {
    display: block;
    color: #b0bec5;
    font-size: 12px;
    margin-bottom: 4px;
}
.form-group input, .form-group textarea {
    width: 100%;
    background: #2d4060;
    border: 1px solid #3d5070;
    color: #e0f7fa;
    padding: 6px 10px;
    border-radius: 3px;
    font-size: 13px;
}
</style>

<div class="card-erp">
    <h2>Aylık Faturalama</h2>
    
    <!-- Filtre Çubuğu -->
    <div class="fatura-header">
        <label>Yıl:</label>
        <select id="yil">
            <option>2024</option>
            <option>2025</option>
            <option selected>2026</option>
        </select>
        
        <label>Ay:</label>
        <select id="ay">
            <option>Ocak</option>
            <option selected>Şubat</option>
            <option>Mart</option>
            <option>Nisan</option>
            <option>Mayıs</option>
            <option>Haziran</option>
            <option>Temmuz</option>
            <option>Ağustos</option>
            <option>Eylül</option>
            <option>Ekim</option>
            <option>Kasım</option>
            <option>Aralık</option>
        </select>
        
        <label>Ofis Türü:</label>
        <select id="ofis-turu">
            <option selected>Oda</option>
            <option>Sanal</option>
            <option>Paylaşımlı</option>
            <option>Tümü</option>
        </select>
        
        <button onclick="listele()">Listele</button>
        <button class="danger" onclick="tumuKes()">Tümü Kes</button>
    </div>
    
    <!-- Özet Bar -->
    <div class="ozet-bar">
        <span>Toplam: - TL</span>
        <span>Kesildi: 0/0 | Kesilen: 0,00 TL</span>
    </div>
    
    <!-- Ana İçerik -->
    <div class="fatura-container">
        <!-- SOL: Firma Listesi -->
        <div class="firma-liste">
            <h3>Firmalar</h3>
            <div style="max-height: 600px; overflow-y: auto;">
                <table class="firma-table">
                    <thead>
                        <tr>
                            <th>Firma Adı</th>
                            <th>Ofis</th>
                            <th>Kira (TL)</th>
                            <th>Durum</th>
                            <th>Fatura No</th>
                            <th>Fatura Tutarı</th>
                        </tr>
                    </thead>
                    <tbody id="firma-tbody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 20px; color: #6b7280;">
                                Firma seçmek için listeleyin
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- SAĞ: Fatura Hazırlama -->
        <div>
            <div class="fatura-panel">
                <h3>Fatura Hazırla</h3>
                
                <div class="secili-firma" id="secili-firma">
                    <div class="ad">Firma seçilmedi</div>
                    <div class="bilgi">Ofis: — | Kira: —</div>
                </div>
                
                <h4 style="color: #b0bec5; font-size: 13px; margin: 10px 0 6px 0;">Fatura Kalemleri:</h4>
                <table class="kalem-table">
                    <thead>
                        <tr>
                            <th>Açıklama</th>
                            <th>Tutar</th>
                            <th>KDV%</th>
                        </tr>
                    </thead>
                    <tbody id="kalem-tbody">
                        <tr>
                            <td colspan="3" style="padding: 15px; color: #6b7280;">
                                Sol taraftan firma seçin
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="kalem-ekle">
                    <input type="text" id="kalem-aciklama" placeholder="Açıklama" style="flex: 2;">
                    <input type="text" id="kalem-tutar" placeholder="Tutar" style="width: 80px;">
                    <select id="kalem-kdv" style="width: 70px;">
                        <option>0%</option>
                        <option>10%</option>
                        <option selected>20%</option>
                    </select>
                    <button onclick="kalemEkle()" style="background: #00bcd4; color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer;">+ Ekle</button>
                </div>
                
                <div class="form-group" style="margin-top: 12px;">
                    <label>Vade:</label>
                    <input type="text" id="vade" placeholder="GG.MM.YYYY">
                </div>
                
                <div class="form-group">
                    <label>Not:</label>
                    <textarea id="not" rows="2" placeholder="Açıklama giriniz..."></textarea>
                </div>
                
                <div style="margin-top: 12px; padding: 8px; background: #0f2537; border-radius: 3px; text-align: right;">
                    <span style="color: #4fc3f7; font-weight: bold; font-size: 15px;" id="toplam">Toplam: 0,00 TL</span>
                </div>
                
                <div style="margin-top: 12px; display: flex; flex-direction: column; gap: 6px;">
                    <button onclick="faturaKes()" style="background: #e74c3c; color: white; border: none; padding: 10px; border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 14px;">FATURA KES</button>
                    <button onclick="pdfOnizle()" style="background: #6b7280; color: white; border: none; padding: 8px; border-radius: 3px; cursor: pointer;">PDF Önizle</button>
                    <button onclick="temizle()" style="background: #3d5070; color: white; border: none; padding: 8px; border-radius: 3px; cursor: pointer;">Temizle</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedFirma = null;
let kalemler = [];

function listele() {
    alert('Firmalar listeleniyor...');
    // TODO: AJAX ile firma listesi çek
}

function selectFirma(firma) {
    selectedFirma = firma;
    document.getElementById('secili-firma').innerHTML = `
        <div class="ad">${firma.name}</div>
        <div class="bilgi">Ofis: ${firma.office || '—'} | Kira: ${firma.kira || '0,00'} TL</div>
    `;
}

function kalemEkle() {
    const aciklama = document.getElementById('kalem-aciklama').value;
    const tutar = document.getElementById('kalem-tutar').value;
    const kdv = document.getElementById('kalem-kdv').value;
    
    if (!aciklama || !tutar) {
        alert('Açıklama ve tutar giriniz!');
        return;
    }
    
    kalemler.push({aciklama, tutar: parseFloat(tutar), kdv: parseInt(kdv)});
    
    // Tabloyu güncelle
    const tbody = document.getElementById('kalem-tbody');
    tbody.innerHTML = kalemler.map((k, i) => `
        <tr>
            <td>${k.aciklama}</td>
            <td>${k.tutar.toFixed(2)}</td>
            <td>${k.kdv}%</td>
        </tr>
    `).join('');
    
    // Toplamı hesapla
    const toplam = kalemler.reduce((sum, k) => sum + k.tutar * (1 + k.kdv/100), 0);
    document.getElementById('toplam').textContent = `Toplam: ${toplam.toFixed(2)} TL`;
    
    // Formu temizle
    document.getElementById('kalem-aciklama').value = '';
    document.getElementById('kalem-tutar').value = '';
}

function faturaKes() {
    if (!selectedFirma) {
        alert('Lütfen firma seçin!');
        return;
    }
    if (kalemler.length === 0) {
        alert('Lütfen en az bir kalem ekleyin!');
        return;
    }
    alert('Fatura kesiliyor...');
    // TODO: Backend'e gönder
}

function pdfOnizle() {
    alert('PDF önizleme özelliği yakında!');
}

function temizle() {
    kalemler = [];
    document.getElementById('kalem-tbody').innerHTML = '<tr><td colspan="3" style="padding: 15px; color: #6b7280;">Sol taraftan firma seçin</td></tr>';
    document.getElementById('toplam').textContent = 'Toplam: 0,00 TL';
    document.getElementById('vade').value = '';
    document.getElementById('not').value = '';
}

function tumuKes() {
    if (confirm('Tüm firmalar için fatura kesilecek. Emin misiniz?')) {
        alert('Toplu fatura kesme işlemi yapılıyor...');
    }
}
</script>
{% endblock %}